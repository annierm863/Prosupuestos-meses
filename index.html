<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Presupuesto Personal - Versi√≥n Ultimate</title>
    <link rel="stylesheet" href="./styles.css" />
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF para exportaci√≥n a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Cargando datos...</p>
      </div>
    </div>
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <p>Cargando datos...</p>
      </div>
    </div>

    <!-- Pantalla de autenticaci√≥n -->
    <div id="authScreen" class="auth-container">
      <div class="auth-box">
        <h2>üí∞ Presupuesto Personal</h2>
        <div id="authMessage"></div>
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="authEmail" placeholder="tu@email.com" />
        </div>
        <div class="form-group">
          <label>Contrase√±a:</label>
          <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
        <button onclick="login()">Iniciar Sesi√≥n</button>
        <button onclick="register()" class="btn-secondary">Registrarse</button>
      </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div id="mainApp" class="container" style="display: none">
      <div class="header">
        <h1>üí∞ Control de Presupuesto Personal</h1>
        <div class="user-info">
          <span id="userEmail"></span>
          <br />
          <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', this)">
          üìä Dashboard
        </button>
        <button class="tab" onclick="showTab('weeks', this)">üìÖ Semanas</button>
        <button class="tab" onclick="showTab('income', this)">üíµ Ingresos</button>
        <button class="tab" onclick="showTab('expenses', this)">üí∏ Gastos</button>
        <button class="tab" onclick="showTab('work-expenses', this)">
          üöó Gastos Trabajo
        </button>
        <button class="tab" onclick="showTab('monthly', this)">
          üìà Resumen Mensual
        </button>
        <button class="tab" onclick="showTab('goals', this)">üéØ Metas</button>
      </div>

      <div class="content">
        <!-- Dashboard -->
        <div id="dashboard" class="section active">
          <h2>Dashboard General</h2>
          <div id="weekInfo" class="alert alert-info"></div>

          <div class="financial-health" id="financialHealth">
            <h3 style="margin-bottom: 15px">üìä Salud Financiera</h3>
            <div id="healthIndicators"></div>
          </div>

          <div class="dashboard-grid" id="dashboardCards"></div>

          <!-- Gr√°ficos -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="chart-container">
              <canvas id="dashboardChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="expensesChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Semanas -->
        <div id="weeks" class="section">
          <h2>Gesti√≥n de Semanas</h2>

          <div class="week-selector">
            <h3>Crear Nueva Semana</h3>
            <div class="form-group">
              <label>Nombre de la Semana:</label>
              <input
                type="text"
                id="weekName"
                placeholder="Ej: Semana 1 - Noviembre"
              />
            </div>
            <div class="form-group">
              <label>Fecha Inicio:</label>
              <input type="date" id="weekStartDate" />
            </div>
            <div class="form-group">
              <label>Fecha Fin:</label>
              <input type="date" id="weekEndDate" />
            </div>
            <button onclick="createWeek()">‚ûï Crear Semana</button>
          </div>

          <h3>Semanas Activas</h3>
          <div id="weeksList"></div>
        </div>

        <!-- Ingresos -->
        <div id="income" class="section">
          <h2>Registro de Ingresos</h2>

          <div
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 20px;
            "
          >
            <h3>Agregar Ingreso</h3>
            <div class="form-group">
              <label>Tipo de Ingreso:</label>
              <select id="incomeType" onchange="toggleIncomeCategory()">
                <option value="Salario">Salario</option>
                <option value="Freelance">Freelance</option>
                <option value="Inversiones">Inversiones</option>
                <option value="Otros">Otros</option>
              </select>
            </div>
            <div class="form-group" id="incomeCategoryGroup">
              <label>Descripci√≥n:</label>
              <input
                type="text"
                id="incomeDescription"
                placeholder="Describe el ingreso"
              />
            </div>
            <div class="form-group">
              <label>Monto:</label>
              <input
                type="number"
                id="incomeAmount"
                placeholder="0.00"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label>Fecha:</label>
              <input type="date" id="incomeDate" />
            </div>
            <button onclick="addIncome()">üíµ Guardar Ingreso</button>
            <button
              id="cancelEditIncome"
              style="display: none"
              onclick="cancelEditIncome()"
              class="btn-danger"
            >
              ‚ùå Cancelar
            </button>
          </div>

          <h3>Lista de Ingresos</h3>
          <div id="incomeList"></div>
        </div>

        <!-- Gastos -->
        <div id="expenses" class="section">
          <h2>Registro de Gastos</h2>

          <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubTab('programmed', this)">
              üìã Gastos Programados
            </button>
            <button class="sub-tab" onclick="showSubTab('unprogrammed', this)">
              ‚ö° Gastos No Programados
            </button>
          </div>

          <!-- Gastos Programados -->
          <div id="programmed" class="sub-section active">
            <div
              style="
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
              "
            >
              <h3>Agregar Gasto Programado</h3>
              <div class="form-group">
                <label>Descripci√≥n:</label>
                <input
                  type="text"
                  id="programmedDescription"
                  placeholder="Describe el gasto"
                />
              </div>
              <div class="form-group">
                <label>Monto:</label>
                <input
                  type="number"
                  id="programmedAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Categor√≠a:</label>
                <select id="programmedCategory">
                  <option value="Comida">Comida</option>
                  <option value="Transporte">Transporte</option>
                  <option value="Salud">Salud</option>
                  <option value="Servicios">Servicios</option>
                  <option value="Entretenimiento">Entretenimiento</option>
                  <option value="Educaci√≥n">Educaci√≥n</option>
                  <option value="Otros">Otros</option>
                </select>
              </div>
              <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="programmedDate" />
              </div>
              <button onclick="addProgrammedExpense()">
                üí∏ Guardar Gasto Programado
              </button>
              <button
                id="cancelEditProgrammed"
                style="display: none"
                onclick="cancelEditProgrammed()"
                class="btn-danger"
              >
                ‚ùå Cancelar
              </button>
            </div>

            <h3>Lista de Gastos Programados</h3>
            <div id="programmedList"></div>
          </div>

          <!-- Gastos No Programados -->
          <div id="unprogrammed" class="sub-section">
            <div
              style="
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-bottom: 20px;
              "
            >
              <h3>Agregar Gasto No Programado</h3>
              <div class="form-group">
                <label>Descripci√≥n:</label>
                <input
                  type="text"
                  id="unprogrammedDescription"
                  placeholder="Describe el gasto"
                />
              </div>
              <div class="form-group">
                <label>Monto:</label>
                <input
                  type="number"
                  id="unprogrammedAmount"
                  placeholder="0.00"
                  step="0.01"
                />
              </div>
              <div class="form-group">
                <label>Categor√≠a:</label>
                <select id="unprogrammedCategory">
                  <option value="Comida">Comida</option>
                  <option value="Transporte">Transporte</option>
                  <option value="Salud">Salud</option>
                  <option value="Servicios">Servicios</option>
                  <option value="Entretenimiento">Entretenimiento</option>
                  <option value="Educaci√≥n">Educaci√≥n</option>
                  <option value="Emergencia">Emergencia</option>
                  <option value="Otros">Otros</option>
                </select>
              </div>
              <div class="form-group">
                <label>Comentario (opcional):</label>
                <textarea
                  id="unprogrammedComment"
                  placeholder="Notas adicionales..."
                ></textarea>
              </div>
              <div class="form-group">
                <label>Fecha:</label>
                <input type="date" id="unprogrammedDate" />
              </div>
              <button onclick="addUnprogrammedExpense()">
                ‚ö° Guardar Gasto No Programado
              </button>
              <button
                id="cancelEditUnprogrammed"
                style="display: none"
                onclick="cancelEditUnprogrammed()"
                class="btn-danger"
              >
                ‚ùå Cancelar
              </button>
            </div>

            <h3>Lista de Gastos No Programados</h3>
            <div id="unprogrammedList"></div>
          </div>
        </div>

        <!-- Gastos de Trabajo -->
        <div id="work-expenses" class="section">
          <h2>Gastos de Trabajo en la Calle</h2>

          <div
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 20px;
            "
          >
            <h3>Agregar Gasto de Trabajo</h3>
            <div class="form-group">
              <label>Tipo:</label>
              <select id="workType">
                <option value="Gasolina">‚õΩ Gasolina</option>
                <option value="Comida">üçî Comida</option>
              </select>
            </div>
            <div class="form-group">
              <label>Monto:</label>
              <input
                type="number"
                id="workAmount"
                placeholder="0.00"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label>Descripci√≥n:</label>
              <input
                type="text"
                id="workDescription"
                placeholder="Detalles..."
              />
            </div>
            <div class="form-group">
              <label>Fecha:</label>
              <input type="date" id="workDate" />
            </div>
            <button onclick="addWorkExpense()">
              üöó Guardar Gasto de Trabajo
            </button>
            <button
              id="cancelEditWork"
              style="display: none"
              onclick="cancelEditWork()"
              class="btn-danger"
            >
              ‚ùå Cancelar
            </button>
          </div>

          <h3>Lista de Gastos de Trabajo</h3>
          <div id="workList"></div>
        </div>

        <!-- Resumen Mensual -->
        <div id="monthly" class="section">
          <h2>Resumen Mensual</h2>

          <div class="month-selector">
            <h3>Selecciona un Mes</h3>
            <div class="month-grid" id="monthGrid"></div>
          </div>

          <div id="monthlyDetails" style="display: none">
            <h3>Detalles del Mes: <span id="selectedMonth"></span></h3>

            <div class="dashboard-grid" id="monthlyCards"></div>

            <div style="margin: 20px 0">
              <button onclick="exportMonthlyPDF()" class="btn-secondary">
                üìÑ Exportar a PDF
              </button>
              <button onclick="exportMonthlyCSV()" class="btn-success">
                üìä Exportar a CSV
              </button>
            </div>

            <h3>Semanas del Mes</h3>
            <div class="week-grid" id="monthlyWeeks"></div>
          </div>
        </div>

        <!-- Metas de Ahorro -->
        <div id="goals" class="section">
          <h2>üéØ Metas de Ahorro</h2>

          <div
            style="
              background: #f8f9fa;
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 20px;
            "
          >
            <h3>Crear Nueva Meta</h3>
            <div class="form-group">
              <label>Nombre de la Meta:</label>
              <input
                type="text"
                id="goalName"
                placeholder="Ej: Fondo de Emergencia"
              />
            </div>
            <div class="form-group">
              <label>Monto Objetivo:</label>
              <input
                type="number"
                id="goalTarget"
                placeholder="0.00"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label>Fecha L√≠mite:</label>
              <input type="date" id="goalDeadline" />
            </div>
            <button onclick="createGoal()">üéØ Crear Meta</button>
          </div>

          <h3>Mis Metas Activas</h3>
          <div id="goalsList"></div>
        </div>
      </div>
    </div>

    <!-- Modal para detalles -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle"></h3>
          <button class="close-modal" onclick="closeModal()">√ó</button>
        </div>
        <div id="modalBody"></div>
      </div>
    </div>

    <!-- Modal para detalles de semana -->
    <div id="weekDetailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="weekModalTitle"></h3>
          <button class="close-modal" onclick="closeWeekModal()">√ó</button>
        </div>
        <div id="weekModalBody"></div>
      </div>
    </div>

    <script type="module" src="./app.js"></script>
    <!--
    <script type="module">
      // ============= CONFIGURACI√ìN DE FIREBASE =============
      // INSTRUCCIONES: Reemplaza con tus credenciales de Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDeXU4-D6zFaZ0fVjHWg3jSr05sSwuXbWE",
        authDomain: "presupuesto-personal-f734e.firebaseapp.com",
        projectId: "presupuesto-personal-f734e",
        storageBucket: "presupuesto-personal-f734e.firebasestorage.app",
        messagingSenderId: "954801265396",
        appId: "1:954801265396:web:63fbdca8cee8c920585ca1",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
      window.firestore = {
        collection,
        addDoc,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        Timestamp,
      };

      // Estado global
      let currentUser = null;
      let currentWeek = null;
      let selectedMonth = null;
      let editingItem = null;
      let editingType = null;

      // Observador de autenticaci√≥n
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          document.getElementById("authScreen").style.display = "none";
          document.getElementById("mainApp").style.display = "block";
          document.getElementById("userEmail").textContent = user.email;
          initApp();
        } else {
          currentUser = null;
          document.getElementById("authScreen").style.display = "flex";
          document.getElementById("mainApp").style.display = "none";
        }
      });

      // ============= FUNCIONES DE AUTENTICACI√ìN =============
      window.register = async function () {
        const email = document.getElementById("authEmail").value;
        const password = document.getElementById("authPassword").value;

        if (!email || !password) {
          showAuthMessage("Por favor completa todos los campos", "warning");
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          showAuthMessage("¬°Cuenta creada exitosamente!", "success");
        } catch (error) {
          showAuthMessage("Error: " + getSpanishError(error.code), "warning");
        }
      };

      window.login = async function () {
        const email = document.getElementById("authEmail").value;
        const password = document.getElementById("authPassword").value;

        if (!email || !password) {
          showAuthMessage("Por favor completa todos los campos", "warning");
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
          showAuthMessage("Error: " + getSpanishError(error.code), "warning");
        }
      };

      window.logout = async function () {
        if (confirm("¬øEst√°s seguro que deseas cerrar sesi√≥n?")) {
          await signOut(auth);
        }
      };

      function showAuthMessage(message, type) {
        const messageDiv = document.getElementById("authMessage");
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = "block";
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 5000);
      }

      function getSpanishError(errorCode) {
        const errors = {
          "auth/email-already-in-use": "Este email ya est√° registrado",
          "auth/invalid-email": "Email inv√°lido",
          "auth/weak-password":
            "La contrase√±a debe tener al menos 6 caracteres",
          "auth/user-not-found": "Usuario no encontrado",
          "auth/wrong-password": "Contrase√±a incorrecta",
          "auth/too-many-requests": "Demasiados intentos. Intenta m√°s tarde",
        };
        return errors[errorCode] || "Error desconocido";
      }

      // ============= INICIALIZACI√ìN =============
      async function initApp() {
        await loadWeeks();
        generateMonthGrid();
        setDefaultDates();
        updateDashboard();
        loadGoals();
      }

      function setDefaultDates() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("incomeDate").value = today;
        document.getElementById("programmedDate").value = today;
        document.getElementById("unprogrammedDate").value = today;
        document.getElementById("workDate").value = today;
        document.getElementById("weekStartDate").value = today;
        document.getElementById("weekEndDate").value = today;
      }

      // ============= GESTI√ìN DE SEMANAS =============
      window.createWeek = async function () {
        const name = document.getElementById("weekName").value;
        const startDate = document.getElementById("weekStartDate").value;
        const endDate = document.getElementById("weekEndDate").value;

        if (!name || !startDate || !endDate) {
          alert("Por favor completa todos los campos");
          return;
        }

        if (new Date(endDate) < new Date(startDate)) {
          alert("La fecha de fin debe ser posterior a la fecha de inicio");
          return;
        }

        try {
          const weekData = {
            userId: currentUser.uid,
            name: name,
            startDate: startDate,
            endDate: endDate,
            createdAt: Timestamp.now(),
          };

          await addDoc(collection(db, "weeks"), weekData);

          alert("‚úÖ Semana creada exitosamente");
          document.getElementById("weekName").value = "";
          await loadWeeks();
          updateDashboard();
        } catch (error) {
          alert("Error al crear semana: " + error.message);
        }
      };

      async function loadWeeks() {
        try {
          const q = query(
            collection(db, "weeks"),
            where("userId", "==", currentUser.uid)
          );
          const snapshot = await getDocs(q);
          const weeks = [];

          snapshot.forEach((doc) => {
            weeks.push({ id: doc.id, ...doc.data() });
          });

          // Ordenar por fecha de inicio
          weeks.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

          displayWeeks(weeks);

          // Seleccionar la semana m√°s reciente como activa
          if (weeks.length > 0 && !currentWeek) {
            currentWeek = weeks[0];
          }
        } catch (error) {
          console.error("Error al cargar semanas:", error);
        }
      }

      function displayWeeks(weeks) {
        const container = document.getElementById("weeksList");

        if (weeks.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No hay semanas creadas a√∫n</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = weeks
          .map(
            (week) => `
                <div class="list-item" style="--item-color: #667eea;" onclick="selectWeek('${
                  week.id
                }')">
                    <div class="list-item-info">
                        <div class="list-item-title">${week.name}</div>
                        <div class="list-item-details">
                            ${formatDate(week.startDate)} - ${formatDate(
              week.endDate
            )}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        ${
                          currentWeek && currentWeek.id === week.id
                            ? '<span style="color: #667eea; font-weight: bold;">‚úì Activa</span>'
                            : '<button class="btn-small btn-success" onclick="event.stopPropagation(); selectWeek(\'' +
                              week.id +
                              "')\">Activar</button>"
                        }
                        <button class="btn-small btn-danger" onclick="event.stopPropagation(); deleteWeek('${
                          week.id
                        }')">üóëÔ∏è</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.selectWeek = async function (weekId) {
        const q = query(
          collection(db, "weeks"),
          where("userId", "==", currentUser.uid)
        );
        const snapshot = await getDocs(q);

        snapshot.forEach((doc) => {
          if (doc.id === weekId) {
            currentWeek = { id: doc.id, ...doc.data() };
          }
        });

        await loadWeeks();
        updateDashboard();
        alert("‚úÖ Semana activada: " + currentWeek.name);
      };

      window.deleteWeek = async function (weekId) {
        if (!confirm("¬øEst√°s seguro de eliminar esta semana?")) return;

        try {
          await deleteDoc(doc(db, "weeks", weekId));

          if (currentWeek && currentWeek.id === weekId) {
            currentWeek = null;
          }

          alert("‚úÖ Semana eliminada");
          await loadWeeks();
          updateDashboard();
        } catch (error) {
          alert("Error al eliminar semana: " + error.message);
        }
      };

      // ============= GESTI√ìN DE INGRESOS =============
      window.toggleIncomeCategory = function () {
        const type = document.getElementById("incomeType").value;
        const categoryGroup = document.getElementById("incomeCategoryGroup");

        if (type === "Salario") {
          categoryGroup.style.display = "none";
        } else {
          categoryGroup.style.display = "block";
        }
      };

      window.addIncome = async function () {
        if (!currentWeek) {
          alert("‚ö†Ô∏è Primero debes crear y activar una semana");
          return;
        }

        const type = document.getElementById("incomeType").value;
        const description =
          type === "Salario"
            ? "Salario"
            : document.getElementById("incomeDescription").value;
        const amount = parseFloat(
          document.getElementById("incomeAmount").value
        );
        const date = document.getElementById("incomeDate").value;

        if (!amount || amount <= 0 || !date) {
          alert("Por favor completa todos los campos correctamente");
          return;
        }

        try {
          const incomeData = {
            userId: currentUser.uid,
            weekId: currentWeek.id,
            type: type,
            description: description,
            amount: amount,
            date: date,
            createdAt: Timestamp.now(),
          };

          if (editingItem && editingType === "income") {
            await updateDoc(doc(db, "incomes", editingItem), incomeData);
            alert("‚úÖ Ingreso actualizado");
            cancelEditIncome();
          } else {
            await addDoc(collection(db, "incomes"), incomeData);
            alert("‚úÖ Ingreso registrado");
          }

          // Limpiar formulario
          document.getElementById("incomeType").value = "Salario";
          document.getElementById("incomeDescription").value = "";
          document.getElementById("incomeAmount").value = "";

          await loadIncomes();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      async function loadIncomes() {
        if (!currentWeek) return;

        try {
          const q = query(
            collection(db, "incomes"),
            where("userId", "==", currentUser.uid),
            where("weekId", "==", currentWeek.id)
          );
          const snapshot = await getDocs(q);
          const incomes = [];

          snapshot.forEach((doc) => {
            incomes.push({ id: doc.id, ...doc.data() });
          });

          // Ordenar por fecha
          incomes.sort((a, b) => new Date(b.date) - new Date(a.date));

          displayIncomes(incomes);
        } catch (error) {
          console.error("Error al cargar ingresos:", error);
        }
      }

      function displayIncomes(incomes) {
        const container = document.getElementById("incomeList");

        if (incomes.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üíµ</div>
                        <p>No hay ingresos registrados a√∫n</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = incomes
          .map(
            (income) => `
                <div class="list-item" style="--item-color: #4ade80;">
                    <div class="list-item-info">
                        <div class="list-item-title">${income.type}${
              income.description && income.type !== "Salario"
                ? " - " + income.description
                : ""
            }</div>
                        <div class="list-item-details">üìÖ ${formatDate(
                          income.date
                        )}</div>
                    </div>
                    <div class="list-item-amount">$${income.amount.toFixed(
                      2
                    )}</div>
                    <div class="list-item-actions">
                        <button class="btn-small btn-success" onclick="editIncome('${
                          income.id
                        }', ${JSON.stringify(income).replace(
              /"/g,
              "&quot;"
            )})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteIncome('${
                          income.id
                        }')">üóëÔ∏è</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.editIncome = function (id, income) {
        editingItem = id;
        editingType = "income";

        document.getElementById("incomeType").value = income.type;
        document.getElementById("incomeDescription").value =
          income.description || "";
        document.getElementById("incomeAmount").value = income.amount;
        document.getElementById("incomeDate").value = income.date;

        document.getElementById("cancelEditIncome").style.display = "block";
        toggleIncomeCategory();

        // Scroll al formulario
        document
          .getElementById("income")
          .scrollIntoView({ behavior: "smooth", block: "start" });
      };

      window.cancelEditIncome = function () {
        editingItem = null;
        editingType = null;
        document.getElementById("incomeType").value = "Salario";
        document.getElementById("incomeDescription").value = "";
        document.getElementById("incomeAmount").value = "";
        document.getElementById("cancelEditIncome").style.display = "none";
      };

      window.deleteIncome = async function (id) {
        if (!confirm("¬øEst√°s seguro de eliminar este ingreso?")) return;

        try {
          await deleteDoc(doc(db, "incomes", id));
          alert("‚úÖ Ingreso eliminado");
          await loadIncomes();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      // ============= GESTI√ìN DE GASTOS PROGRAMADOS =============
      window.addProgrammedExpense = async function () {
        if (!currentWeek) {
          alert("‚ö†Ô∏è Primero debes crear y activar una semana");
          return;
        }

        const description = document.getElementById(
          "programmedDescription"
        ).value;
        const amount = parseFloat(
          document.getElementById("programmedAmount").value
        );
        const category = document.getElementById("programmedCategory").value;
        const date = document.getElementById("programmedDate").value;

        if (!description || !amount || amount <= 0 || !date) {
          alert("Por favor completa todos los campos correctamente");
          return;
        }

        try {
          const expenseData = {
            userId: currentUser.uid,
            weekId: currentWeek.id,
            type: "programmed",
            description: description,
            amount: amount,
            category: category,
            date: date,
            createdAt: Timestamp.now(),
          };

          if (editingItem && editingType === "programmed") {
            await updateDoc(doc(db, "expenses", editingItem), expenseData);
            alert("‚úÖ Gasto actualizado");
            cancelEditProgrammed();
          } else {
            await addDoc(collection(db, "expenses"), expenseData);
            alert("‚úÖ Gasto programado registrado");
          }

          // Limpiar formulario
          document.getElementById("programmedDescription").value = "";
          document.getElementById("programmedAmount").value = "";

          await loadExpenses();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      window.editProgrammed = function (id, expense) {
        editingItem = id;
        editingType = "programmed";

        document.getElementById("programmedDescription").value =
          expense.description;
        document.getElementById("programmedAmount").value = expense.amount;
        document.getElementById("programmedCategory").value = expense.category;
        document.getElementById("programmedDate").value = expense.date;

        document.getElementById("cancelEditProgrammed").style.display = "block";

        // Asegurar que la pesta√±a correcta est√© activa
        showSubTab("programmed");
        showTab("expenses");
      };

      window.cancelEditProgrammed = function () {
        editingItem = null;
        editingType = null;
        document.getElementById("programmedDescription").value = "";
        document.getElementById("programmedAmount").value = "";
        document.getElementById("cancelEditProgrammed").style.display = "none";
      };

      // ============= GESTI√ìN DE GASTOS NO PROGRAMADOS =============
      window.addUnprogrammedExpense = async function () {
        if (!currentWeek) {
          alert("‚ö†Ô∏è Primero debes crear y activar una semana");
          return;
        }

        const description = document.getElementById(
          "unprogrammedDescription"
        ).value;
        const amount = parseFloat(
          document.getElementById("unprogrammedAmount").value
        );
        const category = document.getElementById("unprogrammedCategory").value;
        const comment = document.getElementById("unprogrammedComment").value;
        const date = document.getElementById("unprogrammedDate").value;

        if (!description || !amount || amount <= 0 || !date) {
          alert("Por favor completa todos los campos correctamente");
          return;
        }

        try {
          const expenseData = {
            userId: currentUser.uid,
            weekId: currentWeek.id,
            type: "unprogrammed",
            description: description,
            amount: amount,
            category: category,
            comment: comment,
            date: date,
            createdAt: Timestamp.now(),
          };

          if (editingItem && editingType === "unprogrammed") {
            await updateDoc(doc(db, "expenses", editingItem), expenseData);
            alert("‚úÖ Gasto actualizado");
            cancelEditUnprogrammed();
          } else {
            await addDoc(collection(db, "expenses"), expenseData);
            alert("‚úÖ Gasto no programado registrado");
          }

          // Limpiar formulario
          document.getElementById("unprogrammedDescription").value = "";
          document.getElementById("unprogrammedAmount").value = "";
          document.getElementById("unprogrammedComment").value = "";

          await loadExpenses();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      window.editUnprogrammed = function (id, expense) {
        editingItem = id;
        editingType = "unprogrammed";

        document.getElementById("unprogrammedDescription").value =
          expense.description;
        document.getElementById("unprogrammedAmount").value = expense.amount;
        document.getElementById("unprogrammedCategory").value =
          expense.category;
        document.getElementById("unprogrammedComment").value =
          expense.comment || "";
        document.getElementById("unprogrammedDate").value = expense.date;

        document.getElementById("cancelEditUnprogrammed").style.display =
          "block";

        // Asegurar que la pesta√±a correcta est√© activa
        showSubTab("unprogrammed");
        showTab("expenses");
      };

      window.cancelEditUnprogrammed = function () {
        editingItem = null;
        editingType = null;
        document.getElementById("unprogrammedDescription").value = "";
        document.getElementById("unprogrammedAmount").value = "";
        document.getElementById("unprogrammedComment").value = "";
        document.getElementById("cancelEditUnprogrammed").style.display =
          "none";
      };

      async function loadExpenses() {
        if (!currentWeek) return;

        try {
          const q = query(
            collection(db, "expenses"),
            where("userId", "==", currentUser.uid),
            where("weekId", "==", currentWeek.id)
          );
          const snapshot = await getDocs(q);
          const expenses = [];

          snapshot.forEach((doc) => {
            expenses.push({ id: doc.id, ...doc.data() });
          });

          // Separar por tipo
          const programmed = expenses
            .filter((e) => e.type === "programmed")
            .sort((a, b) => new Date(b.date) - new Date(a.date));
          const unprogrammed = expenses
            .filter((e) => e.type === "unprogrammed")
            .sort((a, b) => new Date(b.date) - new Date(a.date));

          displayProgrammedExpenses(programmed);
          displayUnprogrammedExpenses(unprogrammed);
        } catch (error) {
          console.error("Error al cargar gastos:", error);
        }
      }

      function displayProgrammedExpenses(expenses) {
        const container = document.getElementById("programmedList");

        if (expenses.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No hay gastos programados registrados</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = expenses
          .map(
            (expense) => `
                <div class="list-item" style="--item-color: #f59e0b;">
                    <div class="list-item-info">
                        <div class="list-item-title">${
                          expense.description
                        }</div>
                        <div class="list-item-details">
                            ${getCategoryEmoji(expense.category)} ${
              expense.category
            } ‚Ä¢ üìÖ ${formatDate(expense.date)}
                        </div>
                    </div>
                    <div class="list-item-amount">$${expense.amount.toFixed(
                      2
                    )}</div>
                    <div class="list-item-actions">
                        <button class="btn-small btn-success" onclick="editProgrammed('${
                          expense.id
                        }', ${JSON.stringify(expense).replace(
              /"/g,
              "&quot;"
            )})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteExpense('${
                          expense.id
                        }')">üóëÔ∏è</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function displayUnprogrammedExpenses(expenses) {
        const container = document.getElementById("unprogrammedList");

        if (expenses.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö°</div>
                        <p>No hay gastos no programados registrados</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = expenses
          .map(
            (expense) => `
                <div class="list-item" style="--item-color: #ef4444;">
                    <div class="list-item-info">
                        <div class="list-item-title">‚ö° ${
                          expense.description
                        }</div>
                        <div class="list-item-details">
                            ${getCategoryEmoji(expense.category)} ${
              expense.category
            } ‚Ä¢ üìÖ ${formatDate(expense.date)}
                            ${
                              expense.comment ? "<br>üí¨ " + expense.comment : ""
                            }
                        </div>
                    </div>
                    <div class="list-item-amount">$${expense.amount.toFixed(
                      2
                    )}</div>
                    <div class="list-item-actions">
                        <button class="btn-small btn-success" onclick="editUnprogrammed('${
                          expense.id
                        }', ${JSON.stringify(expense).replace(
              /"/g,
              "&quot;"
            )})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteExpense('${
                          expense.id
                        }')">üóëÔ∏è</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.deleteExpense = async function (id) {
        if (!confirm("¬øEst√°s seguro de eliminar este gasto?")) return;

        try {
          await deleteDoc(doc(db, "expenses", id));
          alert("‚úÖ Gasto eliminado");
          await loadExpenses();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      // ============= GESTI√ìN DE GASTOS DE TRABAJO =============
      window.addWorkExpense = async function () {
        if (!currentWeek) {
          alert("‚ö†Ô∏è Primero debes crear y activar una semana");
          return;
        }

        const type = document.getElementById("workType").value;
        const amount = parseFloat(document.getElementById("workAmount").value);
        const description = document.getElementById("workDescription").value;
        const date = document.getElementById("workDate").value;

        if (!amount || amount <= 0 || !date) {
          alert("Por favor completa todos los campos correctamente");
          return;
        }

        try {
          const workData = {
            userId: currentUser.uid,
            weekId: currentWeek.id,
            type: type,
            amount: amount,
            description: description,
            date: date,
            createdAt: Timestamp.now(),
          };

          if (editingItem && editingType === "work") {
            await updateDoc(doc(db, "workExpenses", editingItem), workData);
            alert("‚úÖ Gasto de trabajo actualizado");
            cancelEditWork();
          } else {
            await addDoc(collection(db, "workExpenses"), workData);
            alert("‚úÖ Gasto de trabajo registrado");
          }

          // Limpiar formulario
          document.getElementById("workAmount").value = "";
          document.getElementById("workDescription").value = "";

          await loadWorkExpenses();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      async function loadWorkExpenses() {
        if (!currentWeek) return;

        try {
          const q = query(
            collection(db, "workExpenses"),
            where("userId", "==", currentUser.uid),
            where("weekId", "==", currentWeek.id)
          );
          const snapshot = await getDocs(q);
          const expenses = [];

          snapshot.forEach((doc) => {
            expenses.push({ id: doc.id, ...doc.data() });
          });

          // Ordenar por fecha
          expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

          displayWorkExpenses(expenses);
        } catch (error) {
          console.error("Error al cargar gastos de trabajo:", error);
        }
      }

      function displayWorkExpenses(expenses) {
        const container = document.getElementById("workList");

        if (expenses.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üöó</div>
                        <p>No hay gastos de trabajo registrados</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = expenses
          .map(
            (expense) => `
                <div class="list-item" style="--item-color: #8b5cf6;">
                    <div class="list-item-info">
                        <div class="list-item-title">${
                          expense.type === "Gasolina" ? "‚õΩ" : "üçî"
                        } ${expense.type}</div>
                        <div class="list-item-details">
                            ${expense.description} ‚Ä¢ üìÖ ${formatDate(
              expense.date
            )}
                        </div>
                    </div>
                    <div class="list-item-amount">$${expense.amount.toFixed(
                      2
                    )}</div>
                    <div class="list-item-actions">
                        <button class="btn-small btn-success" onclick="editWork('${
                          expense.id
                        }', ${JSON.stringify(expense).replace(
              /"/g,
              "&quot;"
            )})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger" onclick="deleteWorkExpense('${
                          expense.id
                        }')">üóëÔ∏è</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.editWork = function (id, expense) {
        editingItem = id;
        editingType = "work";

        document.getElementById("workType").value = expense.type;
        document.getElementById("workAmount").value = expense.amount;
        document.getElementById("workDescription").value = expense.description;
        document.getElementById("workDate").value = expense.date;

        document.getElementById("cancelEditWork").style.display = "block";

        showTab("work-expenses");
      };

      window.cancelEditWork = function () {
        editingItem = null;
        editingType = null;
        document.getElementById("workAmount").value = "";
        document.getElementById("workDescription").value = "";
        document.getElementById("cancelEditWork").style.display = "none";
      };

      window.deleteWorkExpense = async function (id) {
        if (!confirm("¬øEst√°s seguro de eliminar este gasto de trabajo?"))
          return;

        try {
          await deleteDoc(doc(db, "workExpenses", id));
          alert("‚úÖ Gasto de trabajo eliminado");
          await loadWorkExpenses();
          updateDashboard();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      // ============= DASHBOARD Y C√ÅLCULOS =============
      async function updateDashboard() {
        if (!currentWeek) {
          document.getElementById("weekInfo").innerHTML =
            '‚ö†Ô∏è No hay semana activa. Ve a la pesta√±a "Semanas" para crear una.';
          document.getElementById("dashboardCards").innerHTML = "";
          return;
        }

        document.getElementById("weekInfo").innerHTML = `
                üìÖ Semana Activa: <strong>${currentWeek.name}</strong><br>
                üìÜ ${formatDate(currentWeek.startDate)} - ${formatDate(
          currentWeek.endDate
        )}
            `;

        // Cargar todos los datos
        const incomes = await getWeekData("incomes", currentWeek.id);
        const expenses = await getWeekData("expenses", currentWeek.id);
        const workExpenses = await getWeekData("workExpenses", currentWeek.id);

        // Calcular totales
        const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
        const programmedExpenses = expenses.filter(
          (e) => e.type === "programmed"
        );
        const unprogrammedExpenses = expenses.filter(
          (e) => e.type === "unprogrammed"
        );

        const totalProgrammed = programmedExpenses.reduce(
          (sum, e) => sum + e.amount,
          0
        );
        const totalUnprogrammed = unprogrammedExpenses.reduce(
          (sum, e) => sum + e.amount,
          0
        );
        const totalWork = workExpenses.reduce((sum, e) => sum + e.amount, 0);
        const totalExpenses = totalProgrammed + totalUnprogrammed + totalWork;

        const balance = totalIncome - totalExpenses;
        const debtPayment = balance > 0 ? balance * 0.6 : 0;
        const freeMoney = balance > 0 ? balance * 0.4 : 0;

        // Mostrar tarjetas
        const cards = [
          {
            title: "Total Ingresos",
            value: `$${totalIncome.toFixed(2)}`,
            color1: "#4ade80",
            color2: "#22c55e",
            click: "showIncomeDetail",
          },
          {
            title: "Gastos Totales",
            value: `$${totalExpenses.toFixed(2)}`,
            color1: "#ef4444",
            color2: "#dc2626",
            click: "showExpenseDetail",
          },
          {
            title: "Gastos Programados",
            value: `$${totalProgrammed.toFixed(2)}`,
            subtitle: `${programmedExpenses.length} gastos`,
            color1: "#f59e0b",
            color2: "#d97706",
            click: "showProgrammedDetail",
          },
          {
            title: "Gastos No Programados",
            value: `$${totalUnprogrammed.toFixed(2)}`,
            subtitle: `${unprogrammedExpenses.length} gastos`,
            color1: "#ef4444",
            color2: "#dc2626",
            click: "showUnprogrammedDetail",
          },
          {
            title: "Gastos de Trabajo",
            value: `$${totalWork.toFixed(2)}`,
            subtitle: `${workExpenses.length} gastos`,
            color1: "#8b5cf6",
            color2: "#7c3aed",
            click: "showWorkDetail",
          },
          {
            title: "Balance Final",
            value: `$${balance.toFixed(2)}`,
            color1: balance >= 0 ? "#10b981" : "#ef4444",
            color2: balance >= 0 ? "#059669" : "#dc2626",
          },
          {
            title: "Pago a Deuda (60%)",
            value: `$${debtPayment.toFixed(2)}`,
            subtitle: `Dinero libre: $${freeMoney.toFixed(2)}`,
            color1: "#3b82f6",
            color2: "#2563eb",
            click: "showDebtDetail",
          },
        ];

        document.getElementById("dashboardCards").innerHTML = cards
          .map(
            (card) => `
                <div class="card" style="--color1: ${card.color1}; --color2: ${
              card.color2
            };" ${card.click ? `onclick="${card.click}()"` : ""}>
                    <div class="card-title">${card.title}</div>
                    <div class="card-value">${card.value}</div>
                    ${
                      card.subtitle
                        ? `<div class="card-subtitle">${card.subtitle}</div>`
                        : ""
                    }
                </div>
            `
          )
          .join("");

        // Calcular salud financiera
        updateFinancialHealth(
          totalIncome,
          totalExpenses,
          totalUnprogrammed,
          debtPayment
        );

        // Recargar listas
        await loadIncomes();
        await loadExpenses();
        await loadWorkExpenses();
      }

      function updateFinancialHealth(
        income,
        expenses,
        unprogrammed,
        debtPayment
      ) {
        if (income === 0) {
          document.getElementById("healthIndicators").innerHTML =
            "<p>Registra tus ingresos para ver indicadores</p>";
          return;
        }

        const savingsRate = (((income - expenses) / income) * 100).toFixed(1);
        const expenseRatio = ((expenses / income) * 100).toFixed(1);
        const unprogrammedRatio = ((unprogrammed / expenses) * 100).toFixed(1);

        let healthStatus = "üü¢ Excelente";
        let healthColor = "#4ade80";

        if (expenseRatio > 90) {
          healthStatus = "üî¥ Cr√≠tico";
          healthColor = "#ef4444";
        } else if (expenseRatio > 70) {
          healthStatus = "üü° Mejorable";
          healthColor = "#f59e0b";
        }

        document.getElementById("healthIndicators").innerHTML = `
                <div class="health-indicator">
                    <span class="health-label">Estado General:</span>
                    <span class="health-value" style="color: ${healthColor};">${healthStatus}</span>
                </div>
                <div class="health-indicator">
                    <span class="health-label">Tasa de Ahorro:</span>
                    <span class="health-value">${savingsRate}%</span>
                </div>
                <div class="health-indicator">
                    <span class="health-label">Gastos vs Ingresos:</span>
                    <span class="health-value">${expenseRatio}%</span>
                </div>
                <div class="health-indicator">
                    <span class="health-label">Gastos No Programados:</span>
                    <span class="health-value">${unprogrammedRatio}% del total</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${Math.min(
                      savingsRate,
                      100
                    )}%;"></div>
                </div>
                ${
                  unprogrammedRatio > 30
                    ? '<div class="alert alert-warning" style="margin-top:10px;">‚ö†Ô∏è Tus gastos no programados son altos. Intenta reducirlos.</div>'
                    : ""
                }
            `;
      }

      async function getWeekData(collection_name, weekId) {
        const q = query(
          collection(db, collection_name),
          where("userId", "==", currentUser.uid),
          where("weekId", "==", weekId)
        );
        const snapshot = await getDocs(q);
        const data = [];
        snapshot.forEach((doc) => {
          data.push({ id: doc.id, ...doc.data() });
        });
        return data;
      }

      // ============= MODALES DE DETALLE =============
      window.showIncomeDetail = async function () {
        const incomes = await getWeekData("incomes", currentWeek.id);
        showDetailModal(
          "üíµ Detalle de Ingresos",
          incomes.map((i) => ({
            title: i.type,
            description: i.description,
            amount: i.amount,
            date: i.date,
          }))
        );
      };

      window.showExpenseDetail = async function () {
        const expenses = await getWeekData("expenses", currentWeek.id);
        showDetailModal(
          "üí∏ Detalle de Gastos Totales",
          expenses.map((e) => ({
            title: e.description,
            description: `${e.category} ‚Ä¢ ${
              e.type === "programmed" ? "üìã Programado" : "‚ö° No Programado"
            }`,
            amount: e.amount,
            date: e.date,
          }))
        );
      };

      window.showProgrammedDetail = async function () {
        const expenses = await getWeekData("expenses", currentWeek.id);
        const programmed = expenses.filter((e) => e.type === "programmed");
        showDetailModal(
          "üìã Gastos Programados",
          programmed.map((e) => ({
            title: e.description,
            description: e.category,
            amount: e.amount,
            date: e.date,
          }))
        );
      };

      window.showUnprogrammedDetail = async function () {
        const expenses = await getWeekData("expenses", currentWeek.id);
        const unprogrammed = expenses.filter((e) => e.type === "unprogrammed");
        showDetailModal(
          "‚ö° Gastos No Programados",
          unprogrammed.map((e) => ({
            title: e.description,
            description: e.category + (e.comment ? " ‚Ä¢ " + e.comment : ""),
            amount: e.amount,
            date: e.date,
          }))
        );
      };

      window.showWorkDetail = async function () {
        const work = await getWeekData("workExpenses", currentWeek.id);
        showDetailModal(
          "üöó Gastos de Trabajo",
          work.map((w) => ({
            title: w.type,
            description: w.description,
            amount: w.amount,
            date: w.date,
          }))
        );
      };

      window.showDebtDetail = async function () {
        // Para el pago de deuda, mostramos el desglose
        const incomes = await getWeekData("incomes", currentWeek.id);
        const expenses = await getWeekData("expenses", currentWeek.id);
        const workExpenses = await getWeekData("workExpenses", currentWeek.id);

        const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
        const totalExpenses =
          expenses.reduce((sum, e) => sum + e.amount, 0) +
          workExpenses.reduce((sum, w) => sum + w.amount, 0);
        const balance = totalIncome - totalExpenses;
        const debtPayment = balance > 0 ? balance * 0.6 : 0;
        const freeMoney = balance > 0 ? balance * 0.4 : 0;

        const content = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h4>C√°lculo de Pago a Deuda</h4>
                    <div style="margin: 15px 0;">
                        <div class="health-indicator">
                            <span class="health-label">Balance Total:</span>
                            <span class="health-value">$${balance.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="health-indicator">
                            <span class="health-label">60% para Deuda:</span>
                            <span class="health-value" style="color: #3b82f6;">$${debtPayment.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="health-indicator">
                            <span class="health-label">40% Dinero Libre:</span>
                            <span class="health-value" style="color: #4ade80;">$${freeMoney.toFixed(
                              2
                            )}</span>
                        </div>
                    </div>
                    ${
                      balance <= 0
                        ? '<div class="alert alert-warning">‚ö†Ô∏è No hay balance positivo esta semana</div>'
                        : ""
                    }
                </div>
            `;

        document.getElementById("modalTitle").textContent = "üí∞ Pago a Deuda";
        document.getElementById("modalBody").innerHTML = content;
        document.getElementById("detailModal").classList.add("active");
      };

      function showDetailModal(title, items) {
        if (items.length === 0) {
          document.getElementById("modalBody").innerHTML =
            '<div class="empty-state"><p>No hay datos para mostrar</p></div>';
        } else {
          const total = items.reduce((sum, item) => sum + item.amount, 0);
          document.getElementById("modalBody").innerHTML = `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h4>Total: $${total.toFixed(2)}</h4>
                        <p style="color: #666; font-size: 14px;">${
                          items.length
                        } registro(s)</p>
                    </div>
                    ${items
                      .map(
                        (item) => `
                        <div class="list-item" style="--item-color: #667eea;">
                            <div class="list-item-info">
                                <div class="list-item-title">${item.title}</div>
                                <div class="list-item-details">${
                                  item.description
                                } ‚Ä¢ üìÖ ${formatDate(item.date)}</div>
                            </div>
                            <div class="list-item-amount">$${item.amount.toFixed(
                              2
                            )}</div>
                        </div>
                    `
                      )
                      .join("")}
                `;
        }

        document.getElementById("modalTitle").textContent = title;
        document.getElementById("detailModal").classList.add("active");
      }

      window.closeModal = function () {
        document.getElementById("detailModal").classList.remove("active");
      };

      // ============= RESUMEN MENSUAL =============
      function generateMonthGrid() {
        const months = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        const currentYear = new Date().getFullYear();

        const grid = document.getElementById("monthGrid");
        grid.innerHTML = months
          .map(
            (month, index) => `
                <div class="month-card" onclick="selectMonth(${index}, ${currentYear})">
                    <div class="month-card-name">${month}</div>
                    <div class="month-card-year">${currentYear}</div>
                </div>
            `
          )
          .join("");
      }

      window.selectMonth = async function (monthIndex, year) {
        selectedMonth = { month: monthIndex, year: year };

        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        document.getElementById(
          "selectedMonth"
        ).textContent = `${monthNames[monthIndex]} ${year}`;
        document.getElementById("monthlyDetails").style.display = "block";

        await loadMonthlyData(monthIndex, year);
      };

      async function loadMonthlyData(month, year) {
        // Obtener todas las semanas del mes
        const q = query(
          collection(db, "weeks"),
          where("userId", "==", currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const allWeeks = [];

        snapshot.forEach((doc) => {
          const weekData = { id: doc.id, ...doc.data() };
          const weekMonth = new Date(weekData.startDate).getMonth();
          const weekYear = new Date(weekData.startDate).getFullYear();

          if (weekMonth === month && weekYear === year) {
            allWeeks.push(weekData);
          }
        });

        allWeeks.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        // Calcular totales del mes
        let totalIncome = 0;
        let totalExpenses = 0;
        let totalProgrammed = 0;
        let totalUnprogrammed = 0;
        let totalWork = 0;
        let totalDebt = 0;

        for (const week of allWeeks) {
          const incomes = await getWeekData("incomes", week.id);
          const expenses = await getWeekData("expenses", week.id);
          const workExpenses = await getWeekData("workExpenses", week.id);

          const weekIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
          const weekProgrammed = expenses
            .filter((e) => e.type === "programmed")
            .reduce((sum, e) => sum + e.amount, 0);
          const weekUnprogrammed = expenses
            .filter((e) => e.type === "unprogrammed")
            .reduce((sum, e) => sum + e.amount, 0);
          const weekWork = workExpenses.reduce((sum, w) => sum + w.amount, 0);
          const weekExpenses = weekProgrammed + weekUnprogrammed + weekWork;
          const weekBalance = weekIncome - weekExpenses;
          const weekDebt = weekBalance > 0 ? weekBalance * 0.6 : 0;

          totalIncome += weekIncome;
          totalExpenses += weekExpenses;
          totalProgrammed += weekProgrammed;
          totalUnprogrammed += weekUnprogrammed;
          totalWork += weekWork;
          totalDebt += weekDebt;
        }

        const totalBalance = totalIncome - totalExpenses;
        const balanceAfterDebt = totalBalance - totalDebt;

        // Mostrar tarjetas del mes
        const cards = [
          {
            title: "Ingresos del Mes",
            value: `$${totalIncome.toFixed(2)}`,
            color1: "#4ade80",
            color2: "#22c55e",
            click: "showMonthIncomeDetail",
          },
          {
            title: "Gastos del Mes",
            value: `$${totalExpenses.toFixed(2)}`,
            color1: "#ef4444",
            color2: "#dc2626",
            click: "showMonthExpenseDetail",
          },
          {
            title: "Balance del Mes",
            value: `$${totalBalance.toFixed(2)}`,
            color1: totalBalance >= 0 ? "#10b981" : "#ef4444",
            color2: totalBalance >= 0 ? "#059669" : "#dc2626",
          },
          {
            title: "Pago Total a Deuda",
            value: `$${totalDebt.toFixed(2)}`,
            color1: "#3b82f6",
            color2: "#2563eb",
            click: "showMonthDebtDetail",
          },
          {
            title: "Balance Post-Deuda",
            value: `$${balanceAfterDebt.toFixed(2)}`,
            color1: balanceAfterDebt >= 0 ? "#10b981" : "#ef4444",
            color2: balanceAfterDebt >= 0 ? "#059669" : "#dc2626",
          },
          {
            title: "Gastos Programados",
            value: `$${totalProgrammed.toFixed(2)}`,
            color1: "#f59e0b",
            color2: "#d97706",
          },
          {
            title: "Gastos No Programados",
            value: `$${totalUnprogrammed.toFixed(2)}`,
            color1: "#ef4444",
            color2: "#dc2626",
          },
          {
            title: "Gastos de Trabajo",
            value: `$${totalWork.toFixed(2)}`,
            color1: "#8b5cf6",
            color2: "#7c3aed",
          },
        ];

        document.getElementById("monthlyCards").innerHTML = cards
          .map(
            (card) => `
                <div class="card" style="--color1: ${card.color1}; --color2: ${
              card.color2
            };" ${card.click ? `onclick="${card.click}()"` : ""}>
                    <div class="card-title">${card.title}</div>
                    <div class="card-value">${card.value}</div>
                </div>
            `
          )
          .join("");

        // Mostrar semanas
        displayMonthlyWeeks(allWeeks);
      }

      function displayMonthlyWeeks(weeks) {
        const container = document.getElementById("monthlyWeeks");

        if (weeks.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No hay semanas en este mes</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = weeks
          .map(
            (week) => `
                <div class="week-card" onclick="showWeekDetail('${week.id}')">
                    <div class="week-card-title">${week.name}</div>
                    <div class="week-card-dates">${formatDate(
                      week.startDate
                    )} - ${formatDate(week.endDate)}</div>
                </div>
            `
          )
          .join("");
      }

      window.showWeekDetail = async function (weekId) {
        // Obtener datos de la semana
        const q = query(
          collection(db, "weeks"),
          where("userId", "==", currentUser.uid)
        );
        const snapshot = await getDocs(q);
        let weekData = null;

        snapshot.forEach((doc) => {
          if (doc.id === weekId) {
            weekData = { id: doc.id, ...doc.data() };
          }
        });

        if (!weekData) return;

        const incomes = await getWeekData("incomes", weekId);
        const expenses = await getWeekData("expenses", weekId);
        const workExpenses = await getWeekData("workExpenses", weekId);

        const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
        const programmed = expenses.filter((e) => e.type === "programmed");
        const unprogrammed = expenses.filter((e) => e.type === "unprogrammed");
        const totalProgrammed = programmed.reduce(
          (sum, e) => sum + e.amount,
          0
        );
        const totalUnprogrammed = unprogrammed.reduce(
          (sum, e) => sum + e.amount,
          0
        );
        const totalWork = workExpenses.reduce((sum, w) => sum + w.amount, 0);
        const totalExpenses = totalProgrammed + totalUnprogrammed + totalWork;
        const balance = totalIncome - totalExpenses;
        const debtPayment = balance > 0 ? balance * 0.6 : 0;
        const freeMoney = balance > 0 ? balance * 0.4 : 0;

        const content = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>${weekData.name}</h4>
                    <p style="color: #666;">${formatDate(
                      weekData.startDate
                    )} - ${formatDate(weekData.endDate)}</p>
                </div>

                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="card" style="--color1: #4ade80; --color2: #22c55e;">
                        <div class="card-title">Ingresos</div>
                        <div class="card-value">$${totalIncome.toFixed(2)}</div>
                    </div>
                    <div class="card" style="--color1: #ef4444; --color2: #dc2626;">
                        <div class="card-title">Gastos</div>
                        <div class="card-value">$${totalExpenses.toFixed(
                          2
                        )}</div>
                    </div>
                    <div class="card" style="--color1: ${
                      balance >= 0 ? "#10b981" : "#ef4444"
                    }; --color2: ${balance >= 0 ? "#059669" : "#dc2626"};">
                        <div class="card-title">Balance</div>
                        <div class="card-value">$${balance.toFixed(2)}</div>
                    </div>
                    <div class="card" style="--color1: #3b82f6; --color2: #2563eb;">
                        <div class="card-title">Pago Deuda</div>
                        <div class="card-value">$${debtPayment.toFixed(2)}</div>
                        <div class="card-subtitle">Libre: $${freeMoney.toFixed(
                          2
                        )}</div>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0;">Desglose de Gastos</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div class="health-indicator">
                        <span class="health-label">üìã Gastos Programados:</span>
                        <span class="health-value">$${totalProgrammed.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="health-indicator">
                        <span class="health-label">‚ö° Gastos No Programados:</span>
                        <span class="health-value">$${totalUnprogrammed.toFixed(
                          2
                        )}</span>
                    </div>
                    <div class="health-indicator">
                        <span class="health-label">üöó Gastos de Trabajo:</span>
                        <span class="health-value">$${totalWork.toFixed(
                          2
                        )}</span>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0;">Transacciones</h4>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${[...incomes, ...expenses, ...workExpenses]
                      .sort((a, b) => new Date(b.date) - new Date(a.date))
                      .map((item) => {
                        const isIncome = incomes.includes(item);
                        const isExpense = expenses.includes(item);
                        const isWork = workExpenses.includes(item);

                        let icon = "üíµ";
                        let color = "#4ade80";
                        let title = item.description || item.type;
                        let subtitle = formatDate(item.date);

                        if (isExpense) {
                          icon = item.type === "programmed" ? "üìã" : "‚ö°";
                          color =
                            item.type === "programmed" ? "#f59e0b" : "#ef4444";
                          subtitle = `${item.category} ‚Ä¢ ${formatDate(
                            item.date
                          )}`;
                        } else if (isWork) {
                          icon = item.type === "Gasolina" ? "‚õΩ" : "üçî";
                          color = "#8b5cf6";
                          subtitle = `${item.description} ‚Ä¢ ${formatDate(
                            item.date
                          )}`;
                        }

                        return `
                                <div class="list-item" style="--item-color: ${color}; margin-bottom: 10px;">
                                    <div class="list-item-info">
                                        <div class="list-item-title">${icon} ${title}</div>
                                        <div class="list-item-details">${subtitle}</div>
                                    </div>
                                    <div class="list-item-amount">${
                                      isIncome ? "+" : "-"
                                    }$${item.amount.toFixed(2)}</div>
                                </div>
                            `;
                      })
                      .join("")}
                </div>
            `;

        document.getElementById("weekModalTitle").textContent =
          "Detalle de Semana";
        document.getElementById("weekModalBody").innerHTML = content;
        document.getElementById("weekDetailModal").classList.add("active");
      };

      window.closeWeekModal = function () {
        document.getElementById("weekDetailModal").classList.remove("active");
      };

      // Funciones para mostrar detalles mensuales
      window.showMonthIncomeDetail = async function () {
        const items = await getMonthTransactions("incomes");
        showDetailModal(
          "üíµ Ingresos del Mes",
          items.map((i) => ({
            title: i.type,
            description: i.description,
            amount: i.amount,
            date: i.date,
          }))
        );
      };

      window.showMonthExpenseDetail = async function () {
        const expenses = await getMonthTransactions("expenses");
        const workExpenses = await getMonthTransactions("workExpenses");
        const all = [...expenses, ...workExpenses];

        showDetailModal(
          "üí∏ Gastos del Mes",
          all.map((e) => ({
            title: e.description || e.type,
            description:
              e.category ||
              (e.type === "Gasolina" ? "‚õΩ Gasolina" : "üçî Comida"),
            amount: e.amount,
            date: e.date,
          }))
        );
      };

      window.showMonthDebtDetail = async function () {
        const weeks = await getMonthWeeks();
        let details = [];

        for (const week of weeks) {
          const incomes = await getWeekData("incomes", week.id);
          const expenses = await getWeekData("expenses", week.id);
          const workExpenses = await getWeekData("workExpenses", week.id);

          const totalIncome = incomes.reduce((sum, i) => sum + i.amount, 0);
          const totalExpenses =
            expenses.reduce((sum, e) => sum + e.amount, 0) +
            workExpenses.reduce((sum, w) => sum + w.amount, 0);
          const balance = totalIncome - totalExpenses;
          const debt = balance > 0 ? balance * 0.6 : 0;

          if (debt > 0) {
            details.push({
              title: week.name,
              description: `Balance: $${balance.toFixed(2)}`,
              amount: debt,
              date: week.startDate,
            });
          }
        }

        showDetailModal("üí∞ Pago a Deuda por Semana", details);
      };

      async function getMonthTransactions(collection_name) {
        const weeks = await getMonthWeeks();
        let allItems = [];

        for (const week of weeks) {
          const items = await getWeekData(collection_name, week.id);
          allItems = [...allItems, ...items];
        }

        return allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
      }

      async function getMonthWeeks() {
        if (!selectedMonth) return [];

        const q = query(
          collection(db, "weeks"),
          where("userId", "==", currentUser.uid)
        );
        const snapshot = await getDocs(q);
        const weeks = [];

        snapshot.forEach((doc) => {
          const weekData = { id: doc.id, ...doc.data() };
          const weekMonth = new Date(weekData.startDate).getMonth();
          const weekYear = new Date(weekData.startDate).getFullYear();

          if (
            weekMonth === selectedMonth.month &&
            weekYear === selectedMonth.year
          ) {
            weeks.push(weekData);
          }
        });

        return weeks.sort(
          (a, b) => new Date(a.startDate) - new Date(b.startDate)
        );
      }

      // ============= EXPORTACI√ìN =============
      window.exportMonthlyPDF = function () {
        alert("üìÑ Funcionalidad de exportaci√≥n a PDF en desarrollo");
      };

      window.exportMonthlyCSV = async function () {
        const weeks = await getMonthWeeks();
        let csvData = "Tipo,Descripci√≥n,Categor√≠a,Monto,Fecha,Semana\n";

        for (const week of weeks) {
          const incomes = await getWeekData("incomes", week.id);
          const expenses = await getWeekData("expenses", week.id);
          const workExpenses = await getWeekData("workExpenses", week.id);

          incomes.forEach((i) => {
            csvData += `Ingreso,"${i.description}","${i.type}",${i.amount},${i.date},"${week.name}"\n`;
          });

          expenses.forEach((e) => {
            csvData += `Gasto,"${e.description}","${e.category}",${e.amount},${e.date},"${week.name}"\n`;
          });

          workExpenses.forEach((w) => {
            csvData += `Gasto Trabajo,"${w.description}","${w.type}",${w.amount},${w.date},"${week.name}"\n`;
          });
        }

        const blob = new Blob([csvData], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const monthNames = [
          "Enero",
          "Febrero",
          "Marzo",
          "Abril",
          "Mayo",
          "Junio",
          "Julio",
          "Agosto",
          "Septiembre",
          "Octubre",
          "Noviembre",
          "Diciembre",
        ];

        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `presupuesto_${monthNames[selectedMonth.month]}_${
            selectedMonth.year
          }.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      // ============= METAS DE AHORRO =============
      window.createGoal = async function () {
        const name = document.getElementById("goalName").value;
        const target = parseFloat(document.getElementById("goalTarget").value);
        const deadline = document.getElementById("goalDeadline").value;

        if (!name || !target || target <= 0 || !deadline) {
          alert("Por favor completa todos los campos correctamente");
          return;
        }

        try {
          const goalData = {
            userId: currentUser.uid,
            name: name,
            target: target,
            current: 0,
            deadline: deadline,
            createdAt: Timestamp.now(),
          };

          await addDoc(collection(db, "goals"), goalData);
          alert("‚úÖ Meta creada exitosamente");

          document.getElementById("goalName").value = "";
          document.getElementById("goalTarget").value = "";
          document.getElementById("goalDeadline").value = "";

          loadGoals();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      async function loadGoals() {
        try {
          const q = query(
            collection(db, "goals"),
            where("userId", "==", currentUser.uid)
          );
          const snapshot = await getDocs(q);
          const goals = [];

          snapshot.forEach((doc) => {
            goals.push({ id: doc.id, ...doc.data() });
          });

          displayGoals(goals);
        } catch (error) {
          console.error("Error al cargar metas:", error);
        }
      }

      function displayGoals(goals) {
        const container = document.getElementById("goalsList");

        if (goals.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>No hay metas creadas a√∫n</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = goals
          .map((goal) => {
            const progress = ((goal.current / goal.target) * 100).toFixed(1);
            const daysLeft = Math.ceil(
              (new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24)
            );

            return `
                    <div class="list-item" style="--item-color: #8b5cf6; flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div class="list-item-title">üéØ ${
                                  goal.name
                                }</div>
                                <div class="list-item-details">
                                    Meta: $${goal.target.toFixed(
                                      2
                                    )} ‚Ä¢ Actual: $${goal.current.toFixed(2)}
                                    <br>üìÖ ${daysLeft} d√≠as restantes
                                </div>
                            </div>
                            <button class="btn-small btn-danger" onclick="deleteGoal('${
                              goal.id
                            }')">üóëÔ∏è</button>
                        </div>
                        <div style="width: 100%;">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(
                                  progress,
                                  100
                                )}%;"></div>
                            </div>
                            <p style="text-align: center; margin-top: 5px; font-weight: 600; color: #8b5cf6;">${progress}%</p>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      window.deleteGoal = async function (id) {
        if (!confirm("¬øEst√°s seguro de eliminar esta meta?")) return;

        try {
          await deleteDoc(doc(db, "goals", id));
          alert("‚úÖ Meta eliminada");
          loadGoals();
        } catch (error) {
          alert("Error: " + error.message);
        }
      };

      // ============= NAVEGACI√ìN =============
      window.showTab = function (tabName) {
        // Ocultar todas las secciones
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("active");
        });

        // Desactivar todos los tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Activar la secci√≥n y tab correspondiente
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      };

      window.showSubTab = function (subTabName) {
        // Ocultar todas las sub-secciones
        document.querySelectorAll(".sub-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Desactivar todos los sub-tabs
        document.querySelectorAll(".sub-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Activar la sub-secci√≥n y sub-tab correspondiente
        document.getElementById(subTabName).classList.add("active");
        event.target.classList.add("active");
      };

      // ============= UTILIDADES =============
      function formatDate(dateString) {
        const date = new Date(dateString + "T00:00:00");
        const day = date.getDate().toString().padStart(2, "0");
        const month = (date.getMonth() + 1).toString().padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      function getCategoryEmoji(category) {
        const emojis = {
          Comida: "üçî",
          Transporte: "üöó",
          Salud: "üè•",
          Servicios: "üí°",
          Entretenimiento: "üéÆ",
          Educaci√≥n: "üìö",
          Emergencia: "üö®",
          Otros: "üì¶",
        };
        return emojis[category] || "üì¶";
      }

      // Cerrar modal al hacer clic fuera
      document
        .getElementById("detailModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      document
        .getElementById("weekDetailModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeWeekModal();
          }
        });
    </script>
    -->
  </body>
</html>
